steps:
- task: NodeTool@0
  displayName: 'Install Node 14.x'
  inputs:
    versionSpec: '14.x'

- script: |
    npm install
  displayName: 'Install dependencies'
  workingDirectory: '$(WorkingDirectory)'

- script: |
    npm i npm-version-suffix
  displayName: 'Install npm-version-suffix'
  condition: ne(variables.DeploymentRing, 'stable')
  workingDirectory: '$(WorkingDirectory)'

- script: |
    npm i -g npm-add-script
  displayName: 'Install npm-add-script'
  condition: ne(variables.DeploymentRing, 'stable')
  workingDirectory: '$(WorkingDirectory)'

- script: |
    npm i -g cross-env
  displayName: 'Install cross-env'
  condition: ne(variables.DeploymentRing, 'stable')
  workingDirectory: '$(WorkingDirectory)'

- script: |
    npmAddScript -k add-suffix -v "cross-env SUFFIX=$(VersionSuffix) node ./node_modules/npm-version-suffix/run-add-suffix.js"
  displayName: 'Run npm-add-script with version suffix'
  condition: ne(variables.DeploymentRing, 'stable')
  workingDirectory: '$(WorkingDirectory)'

- script: |
    npm run add-suffix
  displayName: 'Add version suffix'
  condition: ne(variables.DeploymentRing, 'stable')
  workingDirectory: '$(WorkingDirectory)'

- script: |
    npm pack
  displayName: 'Package package'
  workingDirectory: '$(WorkingDirectory)'

- task: CopyFiles@2
  displayName: 'Copy npm files'
  inputs:
    SourceFolder: '$(WorkingDirectory)'
    Contents: '*.tgz'
    TargetFolder: '$(Build.ArtifactStagingDirectory)\npm'

- task: PublishBuildArtifacts@1
  displayName: 'Publish the npm package'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\npm'
    ArtifactName: 'npm'
    publishLocation: 'Container'